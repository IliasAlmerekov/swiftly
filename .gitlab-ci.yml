# .gitlab-ci.yml — Linting, Tests und Deployment für Frontend

image: node:20-alpine

stages:
  - lint
  - typecheck
  - test
  - build
  - e2e
  - deploy

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "push"
    - when: never

variables:
  HUSKY: '0'
  npm_config_cache: '$CI_PROJECT_DIR/.npm'
  NPM_CONFIG_PRODUCTION: 'false'
  PLAYWRIGHT_BROWSERS_PATH: '$CI_PROJECT_DIR/.cache/ms-playwright'

cache:
  key:
    files:
      - package-lock.json
  paths:
    - .npm/
    - .cache/ms-playwright/
  policy: pull-push

default:
  before_script:
    - node --version && npm --version
    - npm ci --cache .npm --prefer-offline --no-audit

# -------- LINTING --------
lint:
  stage: lint
  script:
    - npm run lint -- --max-warnings 0
    - npm run lint:css
    - npm run format:check

typecheck:
  stage: typecheck
  script:
    - npm run type-check
  needs:
    - lint

# -------- TESTS --------
test:unit:
  stage: test
  script:
    - npm run test:run
    - npm run test:coverage
  needs:
    - typecheck
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - coverage/

test:build:
  stage: build
  script:
    - npm run build
  needs:
    - test:unit
  artifacts:
    paths:
      - dist/
    when: always
    expire_in: 1 week

test:e2e:
  stage: e2e
  image: mcr.microsoft.com/playwright:v1.58.0-jammy
  variables:
    PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1'
  script:
    - npm run e2e
  needs:
    - test:build
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - playwright-report/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: never

# -------- DEPLOYMENT --------
deploy:develop:
  stage: deploy
  before_script:
    - |
      node --version && npm --version
      npm ci --cache .npm --prefer-offline --no-audit
      npm install -g netlify-cli@17.34.0
      echo "VITE_API_URL=https://swiftly-helpdesk-backend-dev.onrender.com/api" > .env.production
      echo ".env.production created for develop build"
  script:
    - |
      npm run build
      echo "=== DEBUG: Checking build files ==="
      grep -r "swiftly-helpdesk-backend" dist/ || echo "No backend URL found in dist"
      echo "=== END DEBUG ==="
      echo "Deploying to develop environment (tag $CI_COMMIT_REF_NAME)..."
      echo "Site ID:" $NETLIFY_SITE_ID_DEVELOP
      test -n "$NETLIFY_SITE_ID_DEVELOP" || { echo 'Missing NETLIFY_SITE_ID_DEVELOP'; exit 1; }
      test -n "$NETLIFY_AUTH_TOKEN" || { echo 'Missing NETLIFY_AUTH_TOKEN'; exit 1; }
    - netlify deploy --dir=dist --site=$NETLIFY_SITE_ID_DEVELOP --message "Develop deploy $CI_COMMIT_SHORT_SHA"
  environment:
    name: develop
    url: https://swiftly-helpdesk-develop.netlify.app/
  when: manual
  only:
    - /^v.*$/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

deploy:production:
  stage: deploy
  before_script:
    - |
      node --version && npm --version
      npm ci --cache .npm --prefer-offline --no-audit
      npm install -g netlify-cli@17.34.0
      echo "VITE_API_URL=https://swiftly-helpdesk-backend.onrender.com/api" > .env.production
      echo ".env.production created for production build"
  script:
    - |
      npm run build
      echo "=== DEBUG: Checking build files ==="
      grep -r "swiftly-helpdesk-backend" dist/ || echo "No backend URL found in dist"
      echo "=== END DEBUG ==="
      echo "Deploying to production environment (tag $CI_COMMIT_REF_NAME)..."
      echo "Site ID:" $NETLIFY_SITE_ID_PRODUCTION
      test -n "$NETLIFY_SITE_ID_PRODUCTION" || { echo 'Missing NETLIFY_SITE_ID_PRODUCTION'; exit 1; }
      test -n "$NETLIFY_AUTH_TOKEN" || { echo 'Missing NETLIFY_AUTH_TOKEN'; exit 1; }
    - netlify deploy --dir=dist --site=$NETLIFY_SITE_ID_PRODUCTION --prod --message "Prod deploy $CI_COMMIT_SHORT_SHA"
  environment:
    name: production
    url: https://helpdesk-swiftly.netlify.app/
  when: manual
  only:
    - /^v[0-9]+\.[0-9]+\.[0-9]+$/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
