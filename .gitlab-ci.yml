# .gitlab-ci.yml — Linting, Tests und Deployment für Frontend

image: node:20-alpine

stages:
  - lint
  - test
  - deploy

workflow:
  rules:
    - if: $CI_COMMIT_TAG && $CI_COMMIT_REF_NAME =~ /^v.*/

variables:
  HUSKY: '0'
  npm_config_cache: '$CI_PROJECT_DIR/.npm'
  NPM_CONFIG_PRODUCTION: 'false'

cache:
  key:
    files:
      - package-lock.json
  paths:
    - .npm/
  policy: pull-push

default:
  before_script:
    - node --version && npm --version
    - npm ci --cache .npm --prefer-offline --no-audit

# -------- LINTING --------
lint:
  stage: lint
  script:
    - npm run lint -- --max-warnings 5
    - npm run type-check
    - npm run format:check
    - npm run lint:css
  artifacts:
    reports:
      junit: reports/lint-results.xml
    when: always
    expire_in: 1 week

# -------- TESTS --------
test:unit:
  stage: test
  script:
    - npm run test:run
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      junit: reports/test-results.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    when: always
    expire_in: 1 week

# -------- DEPLOYMENT --------
deploy:develop:
  stage: deploy
  before_script:
    - |
      node --version && npm --version
      npm ci --cache .npm --prefer-offline --no-audit
      npm install -g netlify-cli@17.34.0
      echo "VITE_API_URL=https://scooteq-helpdesk-backend-dev.onrender.com/api" > .env.production
      echo "=== DEBUG: Created .env.production file ==="
      cat .env.production
      echo "=== END DEBUG ==="
  script:
    - |
      npm run build
      echo "=== DEBUG: Checking build files ==="
      grep -r "scooteq-helpdesk-backend" dist/ || echo "No backend URL found in dist"
      echo "=== END DEBUG ==="
      echo "Deploying to develop environment (tag $CI_COMMIT_REF_NAME)..."
      echo "Site ID:" $NETLIFY_SITE_ID_DEVELOP
      test -n "$NETLIFY_SITE_ID_DEVELOP" || { echo 'Missing NETLIFY_SITE_ID_DEVELOP'; exit 1; }
      test -n "$NETLIFY_AUTH_TOKEN" || { echo 'Missing NETLIFY_AUTH_TOKEN'; exit 1; }
    - netlify deploy --dir=dist --site=$NETLIFY_SITE_ID_DEVELOP --auth=$NETLIFY_AUTH_TOKEN --message "Develop deploy $CI_COMMIT_SHORT_SHA"
  environment:
    name: develop
    url: https://scooteq-helpdesk-develop.netlify.app/
  when: manual
  only:
    - /^v.*$/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

deploy:production:
  stage: deploy
  before_script:
    - |
      node --version && npm --version
      npm ci --cache .npm --prefer-offline --no-audit
      npm install -g netlify-cli@17.34.0
      echo "VITE_API_URL=https://scooteq-helpdesk-backend.onrender.com/api" > .env.production
      echo "=== DEBUG: Created .env.production file ==="
      cat .env.production
      echo "=== END DEBUG ==="
  script:
    - |
      npm run build
      echo "=== DEBUG: Checking build files ==="
      grep -r "scooteq-helpdesk-backend" dist/ || echo "No backend URL found in dist"
      echo "=== END DEBUG ==="
      echo "Deploying to production environment (tag $CI_COMMIT_REF_NAME)..."
      echo "Site ID:" $NETLIFY_SITE_ID_PRODUCTION
      test -n "$NETLIFY_SITE_ID_PRODUCTION" || { echo 'Missing NETLIFY_SITE_ID_PRODUCTION'; exit 1; }
      test -n "$NETLIFY_AUTH_TOKEN" || { echo 'Missing NETLIFY_AUTH_TOKEN'; exit 1; }
    - netlify deploy --dir=dist --site=$NETLIFY_SITE_ID_PRODUCTION --auth=$NETLIFY_AUTH_TOKEN --prod --message "Prod deploy $CI_COMMIT_SHORT_SHA"
  environment:
    name: production
    url: https://scooteq-helpdesk.netlify.app/
  when: manual
  only:
    - /^v[0-9]+\.[0-9]+\.[0-9]+$/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
